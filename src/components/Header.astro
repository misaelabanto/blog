---
import { SITE_TITLE } from '../consts';
import { getLangFromUrl, useTranslatedPath } from '../i18n/utils';
import Navigation from './Navigation.astro';
import LanguageSelector from './LanguageSelector.astro';
import { Icon } from 'astro-icon/components';

const currentLang = getLangFromUrl(Astro.url);
const translatePath = useTranslatedPath(currentLang);
const homeUrl = translatePath('/');
---

<header class="m-0 px-4 shadow-md">
	<nav class="flex items-center justify-between">
		<h2 class="m-0">
			<a href={homeUrl} class="no-underline text-xl">{SITE_TITLE}</a>
		</h2>
		
		<!-- Desktop Navigation -->
		<div class="hidden lg:block">
			<Navigation />
		</div>
		
		<!-- Mobile Menu Button -->
		<div class="lg:hidden">
			<div class="dropdown dropdown-end">
				<div tabindex="0" role="button" class="btn btn-ghost btn-square">
					<Icon name="mdi:menu" class="w-6 h-6" />
				</div>
				<div tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-64 p-4 shadow-lg border border-base-300 mt-2">
					<Navigation />
					<div class="divider my-2"></div>
					<div class="flex justify-center">
						<LanguageSelector />
					</div>
				</div>
			</div>
		</div>
		
		<!-- Desktop Controls -->
		<div class="hidden lg:flex items-center gap-4">
			<!-- Language Selector -->
			<LanguageSelector />
			
			<!-- Theme Toggle -->
			<label class="swap swap-rotate">
				<!-- this hidden checkbox controls the state -->
				<input type="checkbox" class="theme-controller" value="dark" />
				
				<!-- sun icon -->
				<Icon name="mdi:weather-sunny" class="swap-on h-6 w-6 fill-current" />
				
				<!-- moon icon -->
				<Icon name="mdi:weather-night" class="swap-off h-6 w-6 fill-current" />
			</label>
			
			<!-- Social Links -->
			<div class="social-links flex">
				<a href="https://github.com/misaelabanto" target="_blank" class="btn btn-ghost btn-sm btn-circle">
					<span class="sr-only">Go to Misael's GitHub</span>
					<Icon name="simple-icons:github" aria-hidden="true" width="20" height="20" />
				</a>
			</div>
		</div>
		
		<!-- Mobile Controls -->
		<div class="lg:hidden flex items-center gap-2">
			<!-- Theme Toggle -->
			<label class="swap swap-rotate">
				<input type="checkbox" class="theme-controller" value="dark" />
				<Icon name="mdi:weather-sunny" class="swap-on h-5 w-5 fill-current" />
				<Icon name="mdi:weather-night" class="swap-off h-5 w-5 fill-current" />
			</label>
			
			<!-- Mobile Language Selector -->
			<div class="sm:hidden">
				<LanguageSelector />
			</div>
		</div>
	</nav>
</header>

<script>
	// Add a script to save the theme to localStorage and update the HTML data-theme attribute
	document.addEventListener('DOMContentLoaded', () => {
		const themeControllers = document.querySelectorAll('.theme-controller') as NodeListOf<HTMLInputElement>;
		
		// Check if there's a theme preference in localStorage
		const savedTheme = localStorage.getItem('theme');
		const isDark = savedTheme === 'dark';
		
		themeControllers.forEach(controller => {
			controller.checked = isDark;
		});
		
		document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
		
		// Add event listener to save theme preference and update HTML attribute
		themeControllers.forEach(controller => {
			controller.addEventListener('change', () => {
				const theme = controller.checked ? 'dark' : 'light';
				localStorage.setItem('theme', theme);
				document.documentElement.setAttribute('data-theme', theme);
				
				// Sync all theme controllers
				themeControllers.forEach(otherController => {
					if (otherController !== controller) {
						otherController.checked = controller.checked;
					}
				});
			});
		});
	});
</script>
